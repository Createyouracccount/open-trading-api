"""
============================================================
í•œêµ­íˆ¬ìì¦ê¶Œ Open API - êµ­ë‚´ì£¼ì‹ ì£¼ìš” ê¸°ëŠ¥ ê°€ì´ë“œ
============================================================

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” êµ­ë‚´ì£¼ì‹ APIì˜ ì£¼ìš” ê¸°ëŠ¥ë“¤ì„ ì„¤ëª…í•˜ê³ 
ì‹¤ì œ ì‚¬ìš© ì˜ˆì œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
"""
import sys
import time
sys.path.extend(['..', '.'])
import kis_auth as ka
from domestic_stock_functions import *

def print_section(title, description=""):
    print("\n" + "=" * 80)
    print(f"[{title}]")
    print("=" * 80)
    if description:
        print(description)
    print()

# ì¸ì¦
print("=" * 80)
print("í•œêµ­íˆ¬ìì¦ê¶Œ Open API - êµ­ë‚´ì£¼ì‹ ê°€ì´ë“œ")
print("=" * 80)
print("\nğŸ” ì¸ì¦ ì¤‘...")
ka.auth(svr="vps")  # ëª¨ì˜íˆ¬ì
trenv = ka.getTREnv()
print("âœ… ì¸ì¦ ì™„ë£Œ!\n")

##############################################################################
# 1. ì£¼ì‹ í˜„ì¬ê°€ ì¡°íšŒ
##############################################################################
print_section(
    "1. ì£¼ì‹ í˜„ì¬ê°€ ì¡°íšŒ - inquire_price()",
    """
ã€ê¸°ëŠ¥ã€‘ íŠ¹ì • ì¢…ëª©ì˜ ì‹¤ì‹œê°„ ì‹œì„¸ ì •ë³´ ì¡°íšŒ
ã€ë°˜í™˜ã€‘ í˜„ì¬ê°€, ë“±ë½ë¥ , ê±°ë˜ëŸ‰, ì‹œê°€/ê³ ê°€/ì €ê°€, 52ì£¼ ìµœê³ /ìµœì € ë“±
ã€í™œìš©ã€‘
  - ë§¤ìˆ˜/ë§¤ë„ ì‹œì  íŒë‹¨ì„ ìœ„í•œ í˜„ì¬ ê°€ê²© í™•ì¸
  - ìë™ë§¤ë§¤ í”„ë¡œê·¸ë¨ì—ì„œ í˜„ì¬ê°€ ê¸°ì¤€ìœ¼ë¡œ ì£¼ë¬¸ê°€ ê³„ì‚°
  - ê´€ì‹¬ ì¢…ëª©ì˜ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
    """
)

result = inquire_price(
    env_dv="demo",
    fid_cond_mrkt_div_code="J",  # J: ì£¼ì‹/ETF/ETN
    fid_input_iscd="005930"      # ì‚¼ì„±ì „ì
)

if not result.empty:
    print("âœ… ì¡°íšŒ ì„±ê³µ")
    print(f"   - ë°˜í™˜ëœ ì»¬ëŸ¼ ìˆ˜: {len(result.columns)}ê°œ")
    print(f"   - ì£¼ìš” ì •ë³´: í˜„ì¬ê°€, ì „ì¼ëŒ€ë¹„, ë“±ë½ë¥ , ê±°ë˜ëŸ‰, ì‹œê°€ì´ì•¡ ë“±")
    print("\nğŸ“Š ë°ì´í„° ìƒ˜í”Œ:")
    print(result.iloc[0].to_dict())
else:
    print("âŒ ì¡°íšŒ ì‹¤íŒ¨")

time.sleep(0.5)

##############################################################################
# 2. ì¼ë´‰/ì£¼ë´‰/ì›”ë´‰ ì°¨íŠ¸ ë°ì´í„°
##############################################################################
print_section(
    "2. ì¼ë´‰ ì°¨íŠ¸ ì¡°íšŒ - inquire_daily_price()",
    """
ã€ê¸°ëŠ¥ã€‘ ê³¼ê±° ì£¼ê°€ ë°ì´í„° ì¡°íšŒ (ì¼ë´‰/ì£¼ë´‰/ì›”ë´‰)
ã€ë°˜í™˜ã€‘ ë‚ ì§œë³„ ì‹œê°€/ê³ ê°€/ì €ê°€/ì¢…ê°€, ê±°ë˜ëŸ‰ ë“±
ã€í™œìš©ã€‘
  - ê¸°ìˆ ì  ë¶„ì„ (ì´ë™í‰ê· ì„ , ë³¼ë¦°ì €ë°´ë“œ, RSI, MACD ë“±)
  - ë°±í…ŒìŠ¤íŒ… (ê³¼ê±° ë°ì´í„° ê¸°ë°˜ ì „ëµ ê²€ì¦)
  - ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    """
)

result = inquire_daily_price(
    env_dv="demo",
    fid_cond_mrkt_div_code="J",
    fid_input_iscd="005930",
    fid_period_div_code="D",  # D: ì¼ë´‰, W: ì£¼ë´‰, M: ì›”ë´‰
    fid_org_adj_prc="0"       # 0: ìˆ˜ì •ì£¼ê°€, 1: ì›ì£¼ê°€
)

if not result.empty:
    print("âœ… ì¡°íšŒ ì„±ê³µ")
    print(f"   - ì¡°íšŒëœ ë°ì´í„°: {len(result)}ì¼ì¹˜")
    print("\nğŸ“Š ìµœê·¼ 5ì¼ ë°ì´í„°:")
    print(f"{'ë‚ ì§œ':<12} {'ì¢…ê°€':>10} {'ì „ì¼ë¹„':>8} {'ë“±ë½ë¥ ':>7} {'ê±°ë˜ëŸ‰':>12}")
    print("-" * 60)
    for idx, row in result.head(5).iterrows():
        print(f"{row['stck_bsop_date']:<12} {row['stck_clpr']:>10} "
              f"{row['prdy_vrss']:>8} {row['prdy_ctrt']:>6}% {row['acml_vol']:>12}")
else:
    print("âŒ ì¡°íšŒ ì‹¤íŒ¨")

time.sleep(0.5)

##############################################################################
# 3. ê±°ë˜ëŸ‰ ìˆœìœ„ ì¡°íšŒ
##############################################################################
print_section(
    "3. ê±°ë˜ëŸ‰ ìˆœìœ„ ì¡°íšŒ - volume_rank()",
    """
ã€ê¸°ëŠ¥ã€‘ ê±°ë˜ëŸ‰ ê¸‰ì¦ ì¢…ëª© ì¡°íšŒ
ã€ë°˜í™˜ã€‘ ì¢…ëª©ì½”ë“œ, ì¢…ëª©ëª…, ê±°ë˜ëŸ‰, ë“±ë½ë¥  ë“±
ã€í™œìš©ã€‘
  - ê±°ë˜ëŸ‰ ê¸‰ì¦ ì¢…ëª© ë°œêµ´
  - ì´ìŠˆ ì¢…ëª© íŒŒì•…
  - ë‹¨ê¸° ë§¤ë§¤ ê¸°íšŒ í¬ì°©
    """
)

result = volume_rank(
    fid_cond_mrkt_div_code="J",
    fid_cond_scr_div_code="20171",
    fid_input_iscd="0000",
    fid_div_cls_code="0",
    fid_blng_cls_code="0",
    fid_trgt_cls_code="0",
    fid_trgt_exls_cls_code="0",
    fid_input_price_1="",
    fid_input_price_2="",
    fid_vol_cnt="",
    fid_input_date_1=""
)

if not result.empty:
    print("âœ… ì¡°íšŒ ì„±ê³µ")
    print(f"   - ì¡°íšŒëœ ì¢…ëª©: {len(result)}ê°œ")
    print("\nğŸ“Š ê±°ë˜ëŸ‰ ìƒìœ„ 10ê°œ ì¢…ëª©:")
    print(f"{'ìˆœìœ„':<5} {'ì¢…ëª©ëª…':<15} {'í˜„ì¬ê°€':>10} {'ê±°ë˜ëŸ‰':>12} {'ë“±ë½ë¥ ':>7}")
    print("-" * 65)
    for idx, row in result.head(10).iterrows():
        rank = row.get('data_rank', idx+1)
        name = row.get('hts_kor_isnm', 'N/A')
        price = row.get('stck_prpr', 'N/A')
        volume = row.get('acml_vol', 'N/A')
        rate = row.get('prdy_ctrt', 'N/A')
        print(f"{rank:<5} {name:<15} {price:>10} {volume:>12} {rate:>6}%")
else:
    print("âŒ ì¡°íšŒ ì‹¤íŒ¨")

time.sleep(0.5)

##############################################################################
# 4. ì”ê³  ì¡°íšŒ
##############################################################################
print_section(
    "4. ì”ê³  ì¡°íšŒ - inquire_balance()",
    """
ã€ê¸°ëŠ¥ã€‘ ë³´ìœ  ì¢…ëª© ë° í‰ê°€ì†ìµ ì¡°íšŒ
ã€ë°˜í™˜ã€‘ ì¢…ëª©ëª…, ë³´ìœ ìˆ˜ëŸ‰, ë§¤ì…ê°€, í˜„ì¬ê°€, í‰ê°€ì†ìµ ë“±
ã€í™œìš©ã€‘
  - í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™© íŒŒì•…
  - ì†ì ˆ/ìµì ˆ íƒ€ì´ë° íŒë‹¨
  - ë¦¬ë°¸ëŸ°ì‹±ì„ ìœ„í•œ ë³´ìœ  ë¹„ì¤‘ ê³„ì‚°
    """
)

result1, result2 = inquire_balance(
    env_dv="demo",
    cano=trenv.my_acct,
    acnt_prdt_cd=trenv.my_prod,
    afhr_flpr_yn="N",
    inqr_dvsn="02",
    unpr_dvsn="01",
    fund_sttl_icld_yn="N",
    fncg_amt_auto_rdpt_yn="N",
    prcs_dvsn="00",
    FK100="",
    NK100=""
)

if not result1.empty and len(result1) > 0:
    print("âœ… ì¡°íšŒ ì„±ê³µ")
    print(f"   - ë³´ìœ  ì¢…ëª©: {len(result1)}ê°œ")
    print("\nğŸ“Š ë³´ìœ  ì¢…ëª© ìƒì„¸:")
    print(result1[['prdt_name', 'hldg_qty', 'pchs_avg_pric', 'prpr', 'evlu_pfls_amt']].to_string())
else:
    print("âœ… ì¡°íšŒ ì„±ê³µ (ë³´ìœ  ì¢…ëª© ì—†ìŒ)")

time.sleep(0.5)

##############################################################################
# 5. ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡ ì¡°íšŒ
##############################################################################
print_section(
    "5. ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡ ì¡°íšŒ - inquire_psbl_order()",
    """
ã€ê¸°ëŠ¥ã€‘ íŠ¹ì • ì¢…ëª©ì˜ ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡ ë° ìˆ˜ëŸ‰ ì¡°íšŒ
ã€ë°˜í™˜ã€‘ ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡, ì£¼ë¬¸ ê°€ëŠ¥ ìˆ˜ëŸ‰ ë“±
ã€í™œìš©ã€‘
  - ì£¼ë¬¸ ì „ ë§¤ìˆ˜ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  - ë¶„í•  ë§¤ìˆ˜ ì‹œ ìˆ˜ëŸ‰ ê³„ì‚°
  - ì˜ˆìˆ˜ê¸ˆ ë¶€ì¡± ì—¬ë¶€ ì²´í¬
    """
)

result = inquire_psbl_order(
    env_dv="demo",
    cano=trenv.my_acct,
    acnt_prdt_cd=trenv.my_prod,
    pdno="005930",
    ord_unpr="0",
    ord_dvsn="01",
    cma_evlu_amt_icld_yn="Y",
    ovrs_icld_yn="N"
)

if not result.empty:
    print("âœ… ì¡°íšŒ ì„±ê³µ")
    print(f"   - ë§¤ìˆ˜ ê°€ëŠ¥ ê¸ˆì•¡: {result['ord_psbl_cash'].iloc[0]:>15}ì›")
    if 'ord_psbl_qty' in result.columns:
        print(f"   - ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰: {result['ord_psbl_qty'].iloc[0]:>15}ì£¼")
else:
    print("âŒ ì¡°íšŒ ì‹¤íŒ¨")

##############################################################################
# ì¶”ê°€ ê¸°ëŠ¥ ì•ˆë‚´
##############################################################################
print("\n" + "=" * 80)
print("ğŸ“š ê¸°íƒ€ ìœ ìš©í•œ API ê¸°ëŠ¥ë“¤")
print("=" * 80)

functions = [
    ("order_cash", "í˜„ê¸ˆ ë§¤ìˆ˜/ë§¤ë„ ì£¼ë¬¸", "ì‹¤ì œ ì£¼ì‹ ì£¼ë¬¸ ì‹¤í–‰"),
    ("inquire_daily_ccld", "ë‹¹ì¼ ì²´ê²° ë‚´ì—­ ì¡°íšŒ", "ì˜¤ëŠ˜ ì²´ê²°ëœ ì£¼ë¬¸ ë‚´ì—­ í™•ì¸"),
    ("inquire_time_itemchartprice", "ë¶„ë´‰ ë°ì´í„° ì¡°íšŒ", "1ë¶„/5ë¶„/30ë¶„ ë“± ë‹¨ìœ„ ì°¨íŠ¸ ë°ì´í„°"),
    ("volume_rank", "ê±°ë˜ëŸ‰ ìˆœìœ„", "ê±°ë˜ëŸ‰ ê¸‰ì¦ ì¢…ëª© ìŠ¤í¬ë¦¬ë‹"),
    ("fluctuation", "ë“±ë½ë¥  ìˆœìœ„", "ê¸‰ë“±/ê¸‰ë½ ì¢…ëª© ì°¾ê¸°"),
    ("inquire_investor", "íˆ¬ììë³„ ë§¤ë§¤ë™í–¥", "ì™¸êµ­ì¸/ê¸°ê´€ ë§¤ìˆ˜/ë§¤ë„ í˜„í™©"),
    ("inquire_member", "íšŒì›ì‚¬ë³„ ë§¤ë§¤ë™í–¥", "ì¦ê¶Œì‚¬ë³„ ê±°ë˜ í˜„í™©"),
    ("inquire_ccnl", "ì‹œê°„ë³„ ì²´ê²° ë‚´ì—­", "íŠ¹ì • ì¢…ëª©ì˜ ì²´ê²° ì‹œê°„ê³¼ ê°€ê²©"),
]

for func_name, title, desc in functions:
    print(f"\nâ€¢ {func_name}()")
    print(f"  - {title}: {desc}")

print("\n" + "=" * 80)
print("âœ¨ ë” ìì„¸í•œ ì‚¬ìš©ë²•ì€ domestic_stock_functions.py íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”!")
print("=" * 80)
